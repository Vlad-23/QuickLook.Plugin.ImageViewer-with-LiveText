name: Build ImageViewer Plugin

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Resolve Missing Core Dependencies
      run: |
        # This downloads the official QuickLook.Common and QuickLook.Plugin DLLs
        # which are the "Parent" libraries your code is looking for.
        mkdir ql_libs
        nuget install QuickLook.Plugin -Version 0.6.0 -OutputDirectory ./ql_libs
        
        # We find where NuGet put the DLLs and copy them to a central 'ref' folder
        mkdir ref
        Get-ChildItem -Path ./ql_libs -Filter *.dll -Recurse | Copy-Item -Destination ./ref/
        Write-Host "Dependencies ready in ./ref folder"

    - name: Fix GitVersion & Build
      run: |
        # 1. Satisfy the GitVersion.cs requirement (The CS2001 error)
        New-Item -Path "GitVersion.cs" -ItemType File -Force

        # 2. Build while forcing the compiler to look in our new 'ref' folder
        # This solves the 59 errors (Missing Common, IViewer, etc.)
        msbuild QuickLook.Plugin.ImageViewer.csproj `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:ReferencePath="${{ github.workspace }}\ref" `
          /p:GenerateGitVersionInformation=false `
          /p:OutputPath="${{ github.workspace }}\build_output\"

    - name: Upload Finished Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QuickLook-ImageViewer-Plugin
        path: ${{ github.workspace }}\build_output\
