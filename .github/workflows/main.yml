name: Build ImageViewer Plugin

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Get Core Dependencies
      shell: pwsh
      run: |
        # 1. Download the latest QuickLook release to get the 'Common' and 'Plugin' DLLs
        $url = "https://github.com/QL-Win/QuickLook/releases/download/3.7.3/QuickLook.Zip.zip"
        Invoke-WebRequest -Uri $url -OutFile "QuickLook.zip"
        
        # 2. Extract it to a temporary folder
        Expand-Archive -Path "QuickLook.zip" -DestinationPath "./temp_ql"
        
        # 3. Create a 'ref' folder and move the necessary DLLs there
        mkdir ref
        Copy-Item "./temp_ql/QuickLook.Common.dll" -Destination "./ref/"
        Copy-Item "./temp_ql/QuickLook.Plugin.dll" -Destination "./ref/"
        Write-Host "Core DLLs extracted to ./ref folder"

    - name: Fix GitVersion & Build
      run: |
        # Create the missing version file to stop the CS2001 error
        New-Item -Path "GitVersion.cs" -ItemType File -Force

        # Build the project, pointing to our newly extracted reference DLLs
        msbuild QuickLook.Plugin.ImageViewer.csproj `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:ReferencePath="${{ github.workspace }}\ref" `
          /p:GenerateGitVersionInformation=false `
          /p:OutputPath="${{ github.workspace }}\build_output\"

    - name: Upload Finished Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QuickLook-ImageViewer-Plugin
        path: ${{ github.workspace }}\build_output\
