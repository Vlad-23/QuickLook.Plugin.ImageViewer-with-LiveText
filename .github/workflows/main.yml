name: Build and Release QuickLook Plugin

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    # This step will help us see exactly where your files are if the build fails
    - name: Directory Listing Debug
      run: Get-ChildItem -Recurse | Select-Object FullName

    - name: Locate and Restore
      run: |
        # Search for any .sln file in the workspace
        $sln = Get-ChildItem -Path ${{ github.workspace }} -Filter *.sln -Recurse | Select-Object -First 1
        
        if ($null -eq $sln) {
            Write-Host "No .sln found, searching for .csproj instead..."
            $sln = Get-ChildItem -Path ${{ github.workspace }} -Filter *.csproj -Recurse | Select-Object -First 1
        }

        if ($null -eq $sln) {
            throw "Could not find any Solution (.sln) or Project (.csproj) file!"
        }

        Write-Host "Target found at: $($sln.FullName)"
        echo "TARGET_PATH=$($sln.FullName)" >> $env:GITHUB_ENV
        nuget restore "$($sln.FullName)"

    - name: Build Plugin
      run: |
        # We disable GitVersion generation to bypass the CS2001 error
        # We also force the output to a specific 'dist' folder
        msbuild "${{ env.TARGET_PATH }}" `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:UpdateAssemblyInfo=false `
          /p:GenerateGitVersionInformation=false `
          /p:OutputPath="${{ github.workspace }}\dist\"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuickLook-Plugin-Output
        path: ${{ github.workspace }}\dist\
