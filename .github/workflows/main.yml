name: Build Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    steps:
      # 1. Place this repo in a folder named 'ImageViewer'
      - name: Checkout ImageViewer
        uses: actions/checkout@v4
        with:
          path: ImageViewer

      # 2. Place Common in a folder named 'QuickLook.Common'
      - name: Checkout QuickLook.Common
        uses: actions/checkout@v4
        with:
          repository: QL-Win/QuickLook.Common
          path: QuickLook.Common

      # 3. Place the whole QuickLook repo in a temp folder to extract HtmlViewer
      - name: Checkout HtmlViewer
        uses: actions/checkout@v4
        with:
          repository: QL-Win/QuickLook
          path: temp_ql
          sparse-checkout: QuickLook.Plugin/QuickLook.Plugin.HtmlViewer

      # 4. Move HtmlViewer so it is a sibling to the others
      - name: Align HtmlViewer Path
        shell: pwsh
        run: |
          Move-Item -Path "temp_ql/QuickLook.Plugin/QuickLook.Plugin.HtmlViewer" -Destination "./QuickLook.Plugin.HtmlViewer"

      # 5. Create the Version file at the ROOT
      - name: Create Version File
        shell: pwsh
        run: |
          $v = 'using System.Reflection; [assembly: AssemblyVersion("1.0.0.0")]'
          # Placing it here satisfies ..\GitVersion.cs AND ..\..\GitVersion.cs
          New-Item -Path "GitVersion.cs" -ItemType File -Value $v -Force
          # Also place it inside the project folders just in case the .csproj uses a single ..\
          Copy-Item "GitVersion.cs" -Destination "QuickLook.Common/GitVersion.cs"
          Copy-Item "GitVersion.cs" -Destination "QuickLook.Plugin.HtmlViewer/GitVersion.cs"
          Copy-Item "GitVersion.cs" -Destination "ImageViewer/GitVersion.cs"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore and Build
        shell: pwsh
        run: |
          # Restore the main project (this triggers dependency discovery)
          dotnet restore "ImageViewer/QuickLook.Plugin.ImageViewer.csproj"

          # Build Common first (Bypass missing version scripts)
          msbuild "QuickLook.Common/QuickLook.Common.csproj" /p:Configuration=Release /p:PreBuildEvent="" /p:PostBuildEvent=""

          # Build HtmlViewer second
          msbuild "QuickLook.Plugin.HtmlViewer/QuickLook.Plugin.HtmlViewer.csproj" /p:Configuration=Release /p:PreBuildEvent="" /p:PostBuildEvent=""

          # Build Main Project last
          msbuild "ImageViewer/QuickLook.Plugin.ImageViewer.csproj" `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:PreBuildEvent="" `
            /p:PostBuildEvent="" `
            /p:GenerateGitVersionInformation=false `
            /p:OutputPath="../build_output/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickLook.Plugin.ImageViewer
          path: build_output/
