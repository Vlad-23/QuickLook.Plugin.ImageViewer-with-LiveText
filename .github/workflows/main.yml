name: Build Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    steps:
      # 1. Checkout this repo into the root
      - name: Checkout ImageViewer
        uses: actions/checkout@v4
        with:
          path: ImageViewer

      # 2. Checkout Common into the root (so it's sibling to ImageViewer)
      - name: Checkout QuickLook.Common
        uses: actions/checkout@v4
        with:
          repository: QL-Win/QuickLook.Common
          path: QuickLook.Common

      # 3. Checkout HtmlViewer (Sparse)
      - name: Checkout HtmlViewer
        uses: actions/checkout@v4
        with:
          repository: QL-Win/QuickLook
          sparse-checkout: QuickLook.Plugin/QuickLook.Plugin.HtmlViewer
          path: temp_html

      # 4. Move HtmlViewer to the root
      - name: Align HtmlViewer Path
        shell: pwsh
        run: |
          Move-Item -Path "temp_html/QuickLook.Plugin/QuickLook.Plugin.HtmlViewer" -Destination "./QuickLook.Plugin.HtmlViewer"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x86

      - name: Build
        shell: pwsh
        run: |
          # Create GitVersion.cs at the root where ..\..\GitVersion.cs looks
          $v = 'using System.Reflection; [assembly: AssemblyVersion("1.0.0.0")]'
          New-Item -Path "GitVersion.cs" -ItemType File -Value $v -Force

          # RESTORE: We must restore each project individually because they are siblings
          dotnet restore "QuickLook.Common/QuickLook.Common.csproj"
          dotnet restore "QuickLook.Plugin.HtmlViewer/QuickLook.Plugin.HtmlViewer.csproj"
          dotnet restore "ImageViewer/QuickLook.Plugin.ImageViewer.csproj"

          # BUILD COMMON
          msbuild "QuickLook.Common/QuickLook.Common.csproj" `
            /p:Configuration=Release /p:Platform="Any CPU" `
            /p:PreBuildEvent="" /p:PostBuildEvent=""

          # BUILD HTMLVIEWER
          msbuild "QuickLook.Plugin.HtmlViewer/QuickLook.Plugin.HtmlViewer.csproj" `
            /p:Configuration=Release /p:Platform="Any CPU" `
            /p:PreBuildEvent="" /p:PostBuildEvent=""

          # BUILD MAIN PROJECT
          cd ImageViewer
          msbuild QuickLook.Plugin.ImageViewer.csproj `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /p:PreBuildEvent="" `
            /p:PostBuildEvent="" `
            /p:GenerateGitVersionInformation=false `
            /p:OutputPath="../build_output/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: QuickLook.Plugin.ImageViewer
          path: build_output/
